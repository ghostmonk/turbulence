name: Deploy to GCP

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensure full history is fetched

      - name: Detect Changes in Backend
        id: backend_changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q '^backend/'; then
            echo "backend_modified=true" >> $GITHUB_ENV
          else
            echo "backend_modified=false" >> $GITHUB_ENV
          fi

      - name: Deploy Backend
        if: env.backend_modified == 'true'
        run: |
          gcloud builds submit ./backend --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/flexible-backend
          gcloud run deploy flexible-backend \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/flexible-backend \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --set-env-vars MONGO_USER=${{ secrets.MONGO_USER }},MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }},MONGO_CLUSTER=${{ secrets.MONGO_CLUSTER }},MONGO_APP_NAME=${{ secrets.MONGO_APP_NAME }},MONGO_HOST=${{ secrets.MONGO_HOST }} \
            --timeout=600s

  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensure full history is fetched

      - name: Detect Changes in Frontend
        id: frontend_changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q '^frontend/'; then
            echo "frontend_modified=true" >> $GITHUB_ENV
          else
            echo "frontend_modified=false" >> $GITHUB_ENV
          fi

      - name: Deploy Frontend
        if: env.frontend_modified == 'true'
        run: |
          gcloud builds submit ./frontend --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/flexible-frontend
          gcloud run deploy flexible-frontend \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/flexible-frontend \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --timeout=600s

      - name: Make Frontend Public
        if: env.frontend_modified == 'true'
        run: |
          gcloud run services add-iam-policy-binding flexible-frontend \
            --region us-central1 \
            --member="allUsers" \
            --role="roles/run.invoker" \
            --quiet
